#!/usr/bin/env node

const { 
  hasUncommittedChanges, 
  hasStagedChanges, 
  stageAllChanges,
  generateCommitMessage,
  getCurrentPR,
  exec,
  chalk 
} = require('../lib/helpers');

async function main() {
  try {
    // Check for changes
    if (!(await hasUncommittedChanges())) {
      console.log(chalk.green('âœ… No changes to commit'));
      process.exit(0);
    }

    // Stage all changes if none are staged
    if (!(await hasStagedChanges())) {
      await stageAllChanges();
    }

    // Get staged diff
    const diff = await exec('git diff --cached');
    if (!diff) {
      console.log(chalk.red('âœ— No staged changes to commit'));
      process.exit(1);
    }

    // Generate and commit
    console.log(chalk.yellow('ğŸ¤– Generating commit message...'));
    const commitMsg = await generateCommitMessage(diff);
    console.log(chalk.yellow(`ğŸ“ Commit message: ${commitMsg}`));

    try {
      await exec(`git commit -m "${commitMsg}"`);
      console.log(chalk.green('âœ“ Committed successfully'));

      // Show PR if exists
      const prUrl = await getCurrentPR();
      if (prUrl) {
        console.log(chalk.blue(`ğŸ“ PR: ${prUrl}`));
      }
      process.exit(0);
    } catch (error) {
      console.log(chalk.red('âœ— Commit failed'));
      process.exit(1);
    }
  } catch (error) {
    console.error(chalk.red(`Error: ${error.message}`));
    process.exit(1);
  }
}

main();